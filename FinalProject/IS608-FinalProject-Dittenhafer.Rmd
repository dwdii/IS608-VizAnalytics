---
title: "IS608 Final Project"
author: "Daniel Dittenhafer"
date: "Monday, March 23, 2015"
output: html_document
---
```{r, echo=FALSE}
options(warn=-1)
repo <- "http://cran.us.r-project.org"
require.package <- function (package)
{
  if(!require(package, quietly=TRUE, character.only=TRUE))
  {
    install.packages(package, repos=repo) 
    library(package, character.only=TRUE)
  }
}

require.package("knitcitations")
require.package("RefManageR")

cleanbib()

cite_options(style="markdown")

bibBirthData <- bibentry(bibtype="Misc",
                         author=person(family="HHS"),
                         publisher="United States Department of Health and Human Services (US DHHS), Centers for Disease Control and Prevention (CDC), National Center for Health Statistics (NCHS), Division of Vital Statistics",
                         title="Natality public-use data 2007-2012 on CDC WONDER Online Database",
                         year=2015,
                         month="January",
                         url="http://wonder.cdc.gov/natality-current.html")

bibLaborData <- bibentry(bibtype="Misc",
                         author=person(family="U.S. Bureau of Labor Statistics"),
                         title="Local Area Unemployment Statistics (LAUS)",
                         year=2015,
                         url="http://download.bls.gov/pub/time.series/la/")
```

```{r}
#####
# FUNCTION: loadBirthData 
#
#
loadBirthData <- function()
{
  # Load the Natality data
  birthFile <- "C:/Code/R/IS608-VizAnalytics/FinalProject/Data/Natality, 2007-2013-StateCounty.txt"
  birthData <- read.table(birthFile, 
                          header=TRUE, 
                          sep="\t", 
                          fill=TRUE, 
                          stringsAsFactors=FALSE,
                          colClasses=c('character', # Notes
                                       'character', # Year
                                       'character', # Year.Code
                                       'character', # Month
                                       'character', # Month.Code
                                       'character', # State
                                       'character', # State.Code
                                       'character', # County
                                       'character', # County.Code
                                       'numeric'))  # Births
  
  #print(birthData[is.na(birthData$Births),])
  birthDataWoNa <- subset(birthData, !is.na(birthData$Births), 
                          select = - c(Notes, County, County.Code))  
  birthDataWoNa <- dplyr::group_by(birthDataWoNa, 
                                   Year, Year.Code, Month, Month.Code, State, State.Code)
  birthDataWoNa <- dplyr::summarise(birthDataWoNa, sum(Births))
  
  return (birthDataWoNa)
}

#####
# FUNCTION: loadBirthData2 
#
#
loadBirthData2 <- function()
{
  # Load the Natality data
  birthFile <- "C:/Code/R/IS608-VizAnalytics/FinalProject/Data/Natality-2003-2006-YearMonthStateAge.txt"
  birthData <- read.table(birthFile, 
                          header=TRUE, 
                          sep="\t", 
                          fill=TRUE, 
                          stringsAsFactors=FALSE,
                          colClasses=c('character', # Notes
                                       'character', # Year
                                       'character', # Year.Code
                                       'character', # Month
                                       'character', # Month.Code
                                       'character', # State
                                       'character', # State.Code
                                       'character', # Age of Mother
                                       'character', # Age of Mother Code
                                       'numeric'))  # Births
  
  #print(birthData[is.na(birthData$Births),])
  birthDataWoNa <- subset(birthData, !is.na(birthData$Births), 
                          select = - c(Notes, Age.of.Mother, Age.of.Mother.Code))  
  birthDataWoNa <- dplyr::group_by(birthDataWoNa, 
                                   Year, Year.Code, Month, Month.Code, State, State.Code)
  birthDataWoNa <- dplyr::summarise(birthDataWoNa, sum(Births))
  
  return (birthDataWoNa)
}
```

The `loadUnemploymentData` function shown below loads the local area unemployment data along with reference datasets for states and periods `r citep(bibLaborData)`. These data sets are cleaned and joined together to facilitate usage in the visualization later.

```{r}
#####
# FUNCTION: loadUnemploymentData 
#
#
loadUnemploymentData <- function()
{
  # Load the Local Area Unemployment data
  path <- "C:/Code/R/IS608-VizAnalytics/FinalProject/Data"
  dataFile <- sprintf("%s/la.data.3.AllStatesS.txt", path)
  dataTable <- read.table(dataFile, 
                          header=TRUE, 
                          sep="\t", 
                          fill=TRUE, 
                          stringsAsFactors=FALSE,
                          #col.names=c('series_id', 'year', 'period', 'value', 'footnote_codes'),
                          colClasses=c('character', # series_id
                                       'numeric',   # year
                                       'character', # period
                                       'numeric'   # value
                                       #, 'character'  # footnote_codes
                                       ))  
  
  # State IDs
  dataFile <- sprintf("%s/la.state_region_division.txt", path)
  states <- read.table(dataFile, 
                          header=TRUE, 
                          sep="\t", 
                          fill=TRUE, 
                          stringsAsFactors=FALSE,
                          col.names=c('srd_code', 'blank', 'srd_text'),
                          colClasses=c('character',  # srd_code
                                       'character' # srd_text
                                       ))
  
  # format for the series id we want (unemployment rate)
  states$series_id <- paste("LASST", states$srd_code, "0000000000003", sep="") #, 
  print(head(states))
  #print(head(dataTable$series_id))
  
  # Period IDs (months)
  dataFile <- sprintf("%s/la.period.txt", path)
  periods <- read.table(dataFile, 
                          header=TRUE, 
                          sep="\t", 
                          fill=TRUE, 
                          stringsAsFactors=FALSE,
                         # col.names=c('srd_code', 'blank', 'srd_text'),
                          colClasses=c('character', 
                                       'character'
                                       ))
  periods$month <- stringr::str_extract(periods$period, "\\d{2,2}")
  periods <- subset(periods, periods$period != "M13")
  print(periods)
  
  # Only between 2003 and 2013
  cleanerData <- subset(dataTable, 2003 <= dataTable$year &  dataTable$year <= 2013)
  # Trim whitespace off the series_id
  cleanerData$series_id <- stringr::str_trim(cleanerData$series_id)
  # join state names and limit to only the unemployment data we care about.
  cleanerData <- plyr::join(cleanerData, states, by="series_id", type="inner")
  # join month info and limit to only the months (excluding annual average)
  cleanerData <- plyr::join(cleanerData, periods, by="period", type="inner")
  
  return (cleanerData)
}

```
```{r}
bd <-loadBirthData()
head(bd)

bd0306 <- loadBirthData2()
head(bd0306)

bd <- rbind(bd, bd0306)

ud <- loadUnemploymentData()
head(ud)
```

The following code snippet saves the massaged local area unemployment data to a comma separated value (CSV) file for reference and later use. 

```{r}
path <- "C:/Code/R/IS608-VizAnalytics/FinalProject/Data"
dataFile <- sprintf("%s/LA-States-2003-2013.csv", path)
bSaveUnempData <- FALSE
if(bSaveUnempData)
{
  write.table(ud, dataFile,sep=",", row.names=FALSE)
}
```

```{r}
colnames(bd) <- c("Year",  "Year.Code",	
                             "Month",	"Month.Code",	"State",	
                             "State Code", "Births") # "County",  "County Code",

colnames(ud) <- c("series_id","Year","period","UnemploymentRate",
                  "footnote_codes","srd_code","blank",
                  "State","period_abbr","Month","monthNum")

ubd <- plyr::join(ud, bd, by=c("Year", "Month", "State"), type="inner")
head(ubd)

bSave <- FALSE
if(bSave)
{
  dataFile <- sprintf("%s/LA-Natality-Combined.csv", path)
  write.table(ubd, dataFile,sep=",", row.names=FALSE)  
}
```


```{r}
gitHubRoot <- "C:/Code/R/IS608-VizAnalytics/FinalProject/Data"
#
# FUNCTION: loadNationalUnemploymentData 
#
loadNationalUnemploymentData <- function()
{
  # Load the Unemployment data
  dataFile <- sprintf("%s/USUnemploymentRates2003-2013.csv", gitHubRoot)
  data <- read.table(dataFile, 
                     header=TRUE, 
                     sep=",", 
                     fill=TRUE, 
                     stringsAsFactors=FALSE) 
  
  # Melt the data to a long format
  data <- reshape2::melt(data, 
               id.vars=c("Year"), 
               variable.name="Month", 
               value.name="UnemploymentRate")
  
  # Transform raw year/month columns into a Date column, sorted
  data <- dplyr::mutate(data, 
                 Date = lubridate::parse_date_time(sprintf("%s-%s-01", 
                                                            Year, 
                                                            Month), 
                                                    orders="ybd"))
  data <- data[order(data$Date), ]

  return (data)
}

unempData <- loadNationalUnemploymentData()
```

```{r}

# Transform raw year/month columns into a Date column
ubd <- dplyr::mutate(ubd, 
                        Date = lubridate::parse_date_time(sprintf("%s-%s-01", 
                                                                  Year.Code, 
                                                                  Month.Code), 
                                                          orders="ymd"))

birthsPerYearMth <- aggregate(Births ~  Date, ubd, sum)
birthsPerYearMth <- birthsPerYearMth[order(birthsPerYearMth$Date), ]
```

```{r births_raw, echo=FALSE, fig.cap="U.S. Births 2003-2013", fig.path='figure/'}
library(ggplot2)
g1 <- ggplot(data=birthsPerYearMth, aes(x=Date))
g1 <- g1 + geom_line(aes(y=Births, colour="Births"))
g1 <- g1 + theme(axis.text.x = element_text(angle=30, vjust=1))
g1 <- g1 + guides(colour = guide_legend("Legend"))
g1 <- g1 + labs(title="United States Births 2003 - 2013",
                x="Time",
                y="Births")
g1
```

```{r}
modelRoot <- 3
nth.root <- function(y, root)
{
  return (y ^ (1/root))
}
```

```{r births_w_model, echo=FALSE, fig.cap="U.S. Births 2003-2013 with Model", fig.path='figure/'}

g1 <- g1 + geom_point(data=unempData, aes(y=-5255729 + 
                                  (-1723086 * UnemploymentRate) + 
                                  (6049242 * nth.root(UnemploymentRate, modelRoot)) +
                                  (454701 * UnemploymentRate * nth.root(UnemploymentRate, 
                                                                                      modelRoot)), 
                                colour="Model")) +
      geom_smooth(aes(y=Births))


g1
```

### References

```{r, results='asis', echo=FALSE}
BibOptions(style="html", bib.style="authortitle")
bibliography()
```